{% extends 'base.html' %}

{% block content %}

{% load crispy_forms_tags %}
{% load static %}
{% load block_extras %}

<link rel="stylesheet" href="{% static 'css/blocks.css' %}">


<div id="loader" style="display:none">
    <div class="d-flex justify-content-center align-items-center" style="height:85vh">
        <h4 class="mr-4">Please wait while our AI generates feedback <br> for ALL the answers in the dataset!</h4>

        <div class="spinner-border text-info" role="status" style="width: 4rem; height: 4rem;">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>

<div id="loaded-page">
    <div class="row">
        <div class="col-4 d-flex align-items-center">
            <a href="{% url 'rubric_refinement_2' question_obj.id %}" class="btn btn-secondary">Stage 2: Rubric Refinement</a>
        </div>
        <div class="col-4 d-flex justify-content-center">
            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#instructionsModal">
                Instructions
            </button>
        </div>
        <div class="col-4 d-flex align-items-center justify-content-end">
            <a href="{% url 'generate_feedback_csv' question_obj.id %}" class="btn btn-secondary" onclick="fadeOutLoadedPage()" >Stage 4: Apply and Export!</a>
        </div>
    </div>
    <br>

    <!-- Modal for youtube video embedded -->
    <!-- Modal -->
    <div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-center">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/AInsSvJqQK4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
        </div>
    </div>

    <h2>Feedback ðŸ’¬</h2>

    {% if question_obj.question_image_url %}
    <h4>Question {{ question_obj.question_exam_id }}: {{ question_obj.question_text }}
        <a data-toggle="collapse" href="#showImg" role="button" aria-expanded="false" aria-controls="showImg">[show image]</a></h4>
    <div class="collapse" id="showImg"> <img src="{% static question_obj.question_image_url %} "  class="rounded mx-auto d-block"></img> </div>
    {% else %}
    <h4>Question {{ question_obj.question_exam_id }}: {{ question_obj.question_text }}</h4>
    {% endif %}

    <p>Total answers: {{ answer_count }}</p>

    <br>

    {% comment %} Iterate through each answer and make a container containing a card for the answer text {% endcomment %}
    {% for answer in answers %}
    {% with feedback=answer.answerfeedback_set.all.first %}
    <div class="row mb-5">
        <div class="col-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Answer {{ forloop.counter }}</h5>
                    <h1 class="card-text" id="anstext_{{answer.id}}">{{ answer.answer_text }}</h1>
                </div>
            </div>
        </div>

        <div class="col-6">
            <div class="row">
                <div class="col-10">
                    <h4 id="feedbacktext_{{answer.id}}" style="color: lightseagreen">{{feedback.feedback}}</h4>
                </div>
                <div class="col-2">
                    <button type="button" id="feedbackedit_{{answer.id}}" class="btn btn-secondary btn-sm btn-block" onclick="edit_feedback({{answer.id}}, {{feedback.id}})">Edit</button>
                    {% comment %} <button type="button" id="feedbackregen_{{answer.id}}" class="btn btn-secondary btn-sm btn-block">Regen</button> {% endcomment %}
                </div>
            </div>
            {% for tag in answer.answertag_set.all %}
                {% comment %} <li>{{tag.tag}} - {{ rubric_dict|get_item:tag.tag }} (relevance: {{ tag|get_tagdict_item:"relevancy" }}
                    {% if tag|get_tagdict_item:"relevancy" != "0" %}, reason: {{ tag|get_tagdict_item:"reasoning" }}{%endif%})</li> {% endcomment %}
                {% if tag|get_tagdict_item:"relevancy" != "0" %}
                    <li><b>{{tag.tag}}</b> - {{ rubric_dict|get_item:tag.tag }} (relevance: {{ tag|get_tagdict_item:"relevancy" }}, reason: {{ tag|get_tagdict_item:"reasoning" }})</li>
                {%endif%}
            {% endfor %}
        </div>
    </div>

    {% endwith %}
    {% endfor %}

    <!-- Modal for editing feedback -->
    <div class="modal fade" id="editingModal" tabindex="-1" role="dialog" aria-labelledby="editingModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editingModalLabel">Editing Feedback</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <p id="answer-text"> </p>
                        <div class="form-group">
                            <label for="feedback-text" class="col-form-label">Answer Highlight:</label>
                            <textarea class="form-control" id="answer-highlight"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="feedback-text" class="col-form-label">Feedback:</label>
                            <textarea rows="4" class="form-control" id="feedback-text"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="feedback-text" class="col-form-label">Feedback Highlight:</label>
                            <textarea class="form-control" id="feedback-highlight"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Update</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .highlight {
        background-color: palegreen;
    }
</style>

<script>
    ans_feedbacks = {{ ans_feedbacks|safe }};
    console.log(ans_feedbacks);

    $(document).ready(function () {

        // highlight function
        function highlight(text, search) {
            var re = new RegExp(search, "gi");
            return text.replace(re, "<span class='highlight'>" + search + "</span>");
        }

        function attachMouseover(link, answer, answer_highlight, answer_highlighted) {
            link.onmouseover = function() {
                answer.innerHTML = answer.innerHTML.replace(answer_highlight, answer_highlighted);
            }
            link.onmouseout = function() {
                answer.innerHTML = answer.innerHTML.replace(answer_highlighted, answer_highlight);
            }
        }

        // for each item in ans_feedbacks dict...
        for (var key in ans_feedbacks) {
            if (ans_feedbacks.hasOwnProperty(key)) {
                associations = ans_feedbacks[key];
                // iterate through each association (list of dicts)
                //for (var i = 0; i < associations.length; i++) {  // TODO: include this for multiple instances of feedback links
                for (var i = 0; i < 1; i++) {
                    // each dict has "answer_highlight" and "feedback_highlight" keys, use these to highlight the answer and feedback for the current answer id
                    var answer_highlight = associations[i]["answer_highlight"];
                    var feedback_highlight = associations[i]["feedback_highlight"];

                    var anstext_el = document.getElementById("anstext_" + key);
                    var feedbacktext_el = document.getElementById("feedbacktext_" + key);

                    // create a link from this word
                    var feedback_highlight_link = "<a href=\"#\" id=\"feedbacklink_" + key + "_" + i + "\">" + feedback_highlight + "</a>";
                    feedbacktext_el.innerHTML = feedbacktext_el.innerHTML.replace(feedback_highlight, feedback_highlight_link);
                    var feedbacklink_el = document.getElementById("feedbacklink_" + key + "_" + i);
                    var answer_highlighted = "<span class=\"highlight\">" + answer_highlight + "</span>";

                    attachMouseover(feedbacklink_el, anstext_el, answer_highlight, answer_highlighted);
                }
            }
        }

    })

    function update_feedback(new_feedback_dict) {
        console.log(new_feedback_dict);
        var feedback_id = new_feedback_dict["feedback_id"];

        $.ajax({
            url: "{% url 'update_feedback'%}" + feedback_id,
            data: {csrfmiddlewaretoken: "{{ csrf_token }}", 'new_feedback':  JSON.stringify(new_feedback_dict)},
            dataType: "json",
            type: 'POST',
        }).done(function(response){
            console.log(response);
        });
    }

    function edit_feedback(answer_id, feedback_id) {
        // get the current answer data from ans_feedbacks
        var answer_data = ans_feedbacks[answer_id][0];

        // fill the current modal
        var answer_text_el = document.getElementById("answer-text");
        var answer_highlight_el = document.getElementById("answer-highlight");
        var feedback_el = document.getElementById("feedback-text");
        var feedback_highlight_el = document.getElementById("feedback-highlight");
        answer_text_el.innerHTML = answer_data["answer_text"];
        answer_highlight_el.innerHTML = answer_data["answer_highlight"];
        feedback_el.innerHTML = answer_data["feedback"];
        feedback_highlight_el.innerHTML = answer_data["feedback_highlight"];

        // attach event listener to update button
        var update_btn = document.getElementsByClassName("btn btn-primary")[0];
        update_btn.onclick = function() {
            var new_feedback = feedback_el.value;
            var new_feedback_highlight = feedback_highlight_el.value;
            var new_answer_highlight = answer_highlight_el.value;

            new_feedback_dict = { "feedback": new_feedback, "feedback_highlight": new_feedback_highlight, "answer_highlight": new_answer_highlight, "answer_id": answer_id, "feedback_id": feedback_id };
            update_feedback(new_feedback_dict);

            location.reload();
        }

        $('#editingModal').modal('show');
    }

    // function to fade out loaded page when button is clicked and fade in loader
    function fadeOutLoadedPage() {
        $( "#loaded-page" ).fadeOut(400, function(){
            $( "#loader" ).fadeIn(400);
        });  
    }

</script>

{% endblock %}