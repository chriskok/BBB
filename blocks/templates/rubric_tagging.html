{% extends 'base.html' %}

{% block content %}

{% load crispy_forms_tags %}
{% load static %}
{% load block_extras %}

<link rel="stylesheet" href="{% static 'css/blocks.css' %}">

<div class="row">
    <div class="col-6 d-flex align-items-center">
        <a href="{% url 'rubric_creation' question_obj.id %}" class="btn btn-secondary">Stage 1: Rubric Creation</a>
    </div>
    <div class="col-6 d-flex align-items-center justify-content-end">
          <a href="#" class="btn btn-secondary">Stage 3: Apply Feedback and Export</a>
    </div>
</div>
<br>

<h2>Rubric Tagging and Feedback</h2>

{% if question_obj.question_image_url %}
<h4>Question {{ question_obj.question_exam_id }}: {{ question_obj.question_text }}
    <a data-toggle="collapse" href="#showImg" role="button" aria-expanded="false" aria-controls="showImg">[show image]</a></h4>
<div class="collapse" id="showImg"> <img src="{% static question_obj.question_image_url %} "  class="rounded mx-auto d-block"></img> </div>
{% else %}
<h4>Question {{ question_obj.question_exam_id }}: {{ question_obj.question_text }}</h4>
{% endif %}

<p>Total answers: {{ answer_count }}</p>

<br>

<h3>TODO</h3>
<li>Highlight the parts of text that the reasoning is based on</li>
<li>Provide guidance/counter showing how many accepted rubrics and feedback is needed - I'm thinking just 3 of each rubric to start</li>
<li>Automatically generated feedback</li>
<li>Button to regenerate all feedback based on existing input</li>

<br>

<div class="card-deck" id="answer_card_deck">
    {% for tag in ans_tags %}
    <div class="card mb-2">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-6">
                    <h4>Answer {{ forloop.counter }}</h4>
                </div>
                <div class="col-6 d-flex justify-content-end">
                    <p class="text-secondary" id="status_{{forloop.counter}}"></p>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-6">
                    <p>{{ tag.answer.answer_text }}</p>
                </div>
                <div class="col-6">
                    <p><b>Rubrics</b>: {{ rubric_dict|rubric_transform:tag.tag }}</p>
                    <p><b>Reason</b>: {{ tag.reasoning_dict }}</p>
                    <p><b>Feedback</b>: -</p>
                    
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                            <input type="radio" name="options" id="accept_{{forloop.counter}}" autocomplete="off" onclick="update_status(this.id)"> Accept
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="options" id="reject_{{forloop.counter}}" autocomplete="off" onclick="update_status(this.id)"> Reject
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="options" id="edit_{{forloop.counter}}" autocomplete="off" onclick="update_status(this.id)"> Edit
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if forloop.counter|divisibleby:2  %} 
    <div class="w-100 d-none d-block"></div> 
    {% endif %}
    {% endfor%}
</div>

<style>
    .highlight {
        background-color: yellow;
    }
</style>

<script>
    $(document).ready(function () {
        
    })

    function update_status(clicked_id) 
    {
        const myArray = clicked_id.split("_");
        let action = myArray[0];
        let id_num = myArray[1];
        
        var status_el = document.getElementById("status_" + id_num)
        status_el.classList.remove("text-success");
        status_el.classList.remove("text-danger");
        status_el.classList.remove("text-secondary");

        if (action == "accept") {
            status_el.innerHTML = "Accepted"
            status_el.classList.add("text-success");
        } else if (action == "reject") {
            status_el.innerHTML = "Rejected"
            status_el.classList.add("text-danger");
        } else if (action == "edit"){
            status_el.innerHTML = "Edited"
            status_el.classList.add("text-secondary");
        }
    }

</script>

{% endblock %}