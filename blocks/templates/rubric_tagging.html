{% extends 'base.html' %}

{% block content %}

{% load crispy_forms_tags %}
{% load static %}
{% load block_extras %}

<link rel="stylesheet" href="{% static 'css/blocks.css' %}">

<div class="row">
    <div class="col-6 d-flex align-items-center">
        <a href="{% url 'rubric_creation' question_obj.id %}" class="btn btn-secondary">Stage 1: Rubric Creation</a>
    </div>
    <div class="col-6 d-flex align-items-center justify-content-end">
          <a href="#" class="btn btn-secondary">Stage 3: Apply Feedback and Export</a>
    </div>
</div>
<br>

<h2>Rubric Tagging and Feedback</h2>

{% if question_obj.question_image_url %}
<h4>Question {{ question_obj.question_exam_id }}: {{ question_obj.question_text }}
    <a data-toggle="collapse" href="#showImg" role="button" aria-expanded="false" aria-controls="showImg">[show image]</a></h4>
<div class="collapse" id="showImg"> <img src="{% static question_obj.question_image_url %} "  class="rounded mx-auto d-block"></img> </div>
{% else %}
<h4>Question {{ question_obj.question_exam_id }}: {{ question_obj.question_text }}</h4>
{% endif %}

<p>Total answers: {{ answer_count }}</p>

<br>

<div class="row">
    <div class="col-12">
        <h3>TODO</h3>
        <li>Highlight the parts of text that the reasoning is based on</li>
        <li>Automatically generated feedback</li>
        <li>Button to regenerate all feedback based on existing input</li>
    </div>
</div>


<br>

<div class="card-deck" id="answer_card_deck">
    {% for tag in ans_tags %}
    <div class="card mb-2">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-6">
                    <h4>Answer {{ forloop.counter }}</h4>
                </div>
                <div class="col-6 d-flex justify-content-end">
                    <p class="text-secondary" id="status_{{ tag.answer.id }}"></p>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-6">
                    <p>{{ tag.answer.answer_text }}</p>
                </div>
                <div class="col-6">
                    <p><b>Rubrics</b>: {{ rubric_dict|rubric_transform:tag.tag }}</p>
                    <p><b>Reason</b>: {{ tag.reasoning_dict }}</p>
                    <p><b>Feedback</b>: -</p>
                    
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                            <input type="radio" name="options" id="accept_{{ tag.answer.id }}_{{ tag.tag }}" autocomplete="off" onclick="update_status(this.id)"> Accept
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="options" id="reject_{{ tag.answer.id }}_{{ tag.tag }}" autocomplete="off" onclick="update_status(this.id)"> Reject
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="options" id="edit_{{ tag.answer.id }}_{{ tag.tag }}" autocomplete="off" onclick="update_status(this.id)"> Edit
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if forloop.counter|divisibleby:2  %} 
    <div class="w-100 d-none d-block"></div> 
    {% endif %}
    {% endfor%}
</div>

<div class="row fixed-bottom p-3" style="pointer-events: none;">
    <div class="col-4"></div>
    <div class="col-4"></div>
    <div class="col-4">
        <div class="card p-3">
            <h4>Progress</h4>
            {% for rubric_id, rubric in rubric_dict.items %}

            <label for="{{rubric_id}}_progress">{{rubric_id}}: {{rubric}}</label>
            <div class="progress">
                <div id="{{rubric_id}}_progress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .highlight {
        background-color: yellow;
    }
</style>

<script>
    $(document).ready(function () {
        
    })

    var r_dict = {{ rubric_dict | safe }};
    var progress_dict = {};
    for(var key in r_dict) {
        progress_dict[key] = [];
    }

    function handle_progress(ans_id, tags, action){
        var individual_tags = tags.split(",");

        for (var i = 0; i < individual_tags.length; i++) {
            var tag = individual_tags[i];
            if (action == "accept" || action == "edit") {
                if(!progress_dict[tag].includes(ans_id)){
                    progress_dict[tag].push(ans_id);
                } 
            } else if (action == "reject") {
                var index = progress_dict[tag].indexOf(ans_id);
                if (index > -1) {
                    progress_dict[tag].splice(index, 1);
                }
            }
        }

        // update progress_bars for each rubric
        for(var key in progress_dict) {
            var progress = Math.min(Math.round(progress_dict[key].length / 3 * 100), 100);
            var progress_bar = document.getElementById(key + "_progress");
            progress_bar.style.width = progress + "%";
            progress_bar.setAttribute("aria-valuenow", progress);
            progress_bar.innerHTML = progress + "%";
        }
    }

    function update_status(clicked_id) 
    {
        const myArray = clicked_id.split("_");
        let action = myArray[0];
        let id_num = myArray[1];
        let tags = myArray[2];
        
        var status_el = document.getElementById("status_" + id_num)
        status_el.classList.remove("text-success");
        status_el.classList.remove("text-danger");
        status_el.classList.remove("text-secondary");

        // console.log(action + ": " + id_num + ", tags: " + tags);
        handle_progress(id_num, tags, action);

        if (action == "accept") {
            status_el.innerHTML = "Accepted"
            status_el.classList.add("text-success");
        } else if (action == "reject") {
            status_el.innerHTML = "Rejected"
            status_el.classList.add("text-danger");
        } else if (action == "edit"){
            status_el.innerHTML = "Edited"
            status_el.classList.add("text-secondary");
        }
    }

</script>

{% endblock %}